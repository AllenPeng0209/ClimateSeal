# 计算引擎设计文档

## 1. 概述

本文档详细描述了AI驱动的产品碳足迹量化平台的计算引擎设计。计算引擎是系统的核心组件，负责执行产品碳足迹(PCF)的计算，处理输入数据，应用计算方法，并生成准确的结果。计算引擎设计遵循模块化原则，支持不同的计算方法和标准，并结合AI技术提高数据处理和计算的智能性。

## 2. 计算引擎架构

### 2.1 总体架构

计算引擎采用分层架构，包含以下核心组件：

```
┌───────────────────────────────────────────────────────────────┐
│                      计算引擎API层                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐    │
│  │  计算任务管理   │  │  参数验证       │  │  结果管理   │    │
│  └─────────────────┘  └─────────────────┘  └─────────────┘    │
└─────────────────────────────┬─────────────────────────────────┘
                              │
┌─────────────────────────────▼─────────────────────────────────┐
│                      计算核心层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐    │
│  │  数据预处理     │  │  计算方法实现   │  │  分配计算   │    │
│  └─────────────────┘  └─────────────────┘  └─────────────┘    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐    │
│  │  不确定性分析   │  │  结果汇总       │  │  后处理     │    │
│  └─────────────────┘  └─────────────────┘  └─────────────┘    │
└─────────────────────────────┬─────────────────────────────────┘
                              │
┌─────────────────────────────▼─────────────────────────────────┐
│                      AI增强层                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐    │
│  │  数据验证       │  │  数据补全       │  │  热点分析   │    │
│  └─────────────────┘  └─────────────────┘  └─────────────┘    │
└─────────────────────────────┬─────────────────────────────────┘
                              │
┌─────────────────────────────▼─────────────────────────────────┐
│                      数据访问层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐    │
│  │  产品/BOM数据   │  │  活动数据       │  │ 排放因子    │    │
│  └─────────────────┘  └─────────────────┘  └─────────────┘    │
└───────────────────────────────────────────────────────────────┘
```

### 2.2 组件功能

1. **计算引擎API层**：

   - 处理计算请求
   - 验证输入参数
   - 管理计算任务生命周期
   - 封装和返回计算结果

2. **计算核心层**：

   - 实现不同的碳足迹计算方法
   - 执行数据预处理和后处理
   - 处理复杂的分配计算
   - 执行不确定性分析

3. **AI增强层**：

   - 应用机器学习验证数据
   - 智能补全缺失数据
   - 识别和分析碳排放热点
   - 提供智能优化建议

4. **数据访问层**：
   - 提供统一的数据访问接口
   - 加载产品和BOM数据
   - 获取活动数据和排放因子
   - 处理数据缓存

## 3. 计算方法实现

### 3.1 支持的计算方法

计算引擎支持以下主要计算方法：

1. **简单累加法**：适用于简单的产品碳足迹初步评估
2. **过程法(Process-based LCA)**：基于产品生命周期各阶段的详细活动数据
3. **投入产出法(IOA)**：基于经济投入产出表的碳足迹计算
4. **混合法**：结合过程法和投入产出法的优势

### 3.2 计算公式

#### 3.2.1 基本计算公式

产品碳足迹(PCF)基本计算公式：

```
PCF = Σ(活动数据 × 排放因子)
```

详细计算公式：

```
PCF = Σ(i=1 to n) [ AD_i × EF_i × GWP_i ]

其中：
- PCF: 产品碳足迹 (kg CO2e)
- AD_i: 第i个活动的活动数据 (如: kWh, kg, km)
- EF_i: 第i个活动的排放因子 (kg GHG/单位活动)
- GWP_i: 第i个温室气体的全球变暖潜势
- n: 活动数量
```

#### 3.2.2 分配计算

对于多产品共享流程，计算引擎支持以下分配方法：

1. **物理分配**：基于物理量(如重量、体积)

   ```
   分配系数 = 产品物理量 / 总物理量
   ```

2. **经济分配**：基于经济价值

   ```
   分配系数 = 产品经济价值 / 总经济价值
   ```

3. **系统扩展**：通过扩展系统边界避免分配

### 3.3 系统边界定义

计算引擎支持不同的系统边界设置：

1. **摇篮到大门(Cradle-to-Gate)**：从原材料提取到产品出厂
2. **摇篮到坟墓(Cradle-to-Grave)**：包含完整生命周期
3. **摇篮到摇篮(Cradle-to-Cradle)**：包含产品回收和再利用
4. **大门到大门(Gate-to-Gate)**：仅包含一个特定生产阶段

## 4. 数据处理流程

### 4.1 计算流程

完整的计算流程包括以下步骤：

1. **输入数据收集**

   - 加载产品和BOM数据
   - 获取活动数据
   - 选择适当的排放因子

2. **数据预处理**

   - 数据验证和清洗
   - 单位转换和标准化
   - 缺失数据处理

3. **计算执行**

   - 应用选定的计算方法
   - 执行必要的分配计算
   - 计算直接和间接排放

4. **结果汇总和分析**

   - 汇总各环节的排放量
   - 执行不确定性分析
   - 识别排放热点

5. **结果后处理**
   - 格式化计算结果
   - 生成详细的计算数据
   - 准备报告数据

### 4.2 数据流图

典型的碳足迹计算数据流程：

```
┌───────────┐     ┌───────────┐     ┌───────────┐
│ 产品数据  │     │ 活动数据  │     │ 排放因子  │
└─────┬─────┘     └─────┬─────┘     └─────┬─────┘
      │                 │                 │
      └────────┬────────┴────────┬───────┘
               │                 │
        ┌──────▼────────┐ ┌─────▼──────┐
        │ 数据预处理    │ │ AI数据验证 │
        └──────┬────────┘ └─────┬──────┘
               │                │
               └───────┬────────┘
                       │
               ┌───────▼────────┐
               │ 计算方法选择   │
               └───────┬────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
┌───────▼───────┐┌─────▼────────┐┌────▼─────────┐
│ 碳足迹计算   ││ 分配计算     ││ 不确定性分析 │
└───────┬───────┘└─────┬────────┘└────┬─────────┘
        │              │              │
        └──────────────┼──────────────┘
                       │
                ┌──────▼──────┐
                │ 结果汇总    │
                └──────┬──────┘
                       │
           ┌───────────┼───────────┐
           │           │           │
    ┌──────▼────┐┌─────▼─────┐┌────▼────────┐
    │ 排放热点 ││ 改进建议  ││ 结果存储    │
    └──────┬────┘└─────┬─────┘└────┬────────┘
           │           │           │
           └───────────┼───────────┘
                       │
                ┌──────▼──────┐
                │ 计算结果API │
                └─────────────┘
```

## 5. AI增强功能

### 5.1 数据验证与异常检测

计算引擎利用机器学习模型对输入数据进行验证：

1. **异常值检测**：识别偏离预期范围的活动数据

   - 使用统计方法(Z-score, IQR)和机器学习模型(隔离森林, 自编码器)
   - 根据历史数据和行业基准自动设置阈值

2. **数据一致性检查**：验证数据间的逻辑关系

   - 能源消耗与产量的比例关系
   - 物料投入与产出的平衡关系

3. **数据质量评分**：为输入数据分配质量评分
   - 基于数据来源、完整性、时效性等指标
   - 影响计算结果的不确定性评估

### 5.2 智能数据补全

对于缺失的活动数据，AI模型可以提供智能补全：

1. **相似产品插值**：

   - 根据产品属性和物料构成识别相似产品
   - 使用相似产品的活动数据进行智能插值

2. **时间序列预测**：

   - 对于缺失的时间段数据，使用时间序列模型(ARIMA, LSTM)预测
   - 考虑季节性因素和长期趋势

3. **多源数据融合**：
   - 整合行业平均数据、历史数据和专家知识
   - 使用贝叶斯方法估计缺失值及其不确定性

### 5.3 排放热点分析

AI模型帮助识别碳足迹的关键贡献因素：

1. **敏感性分析**：

   - 自动评估各输入因素对总碳足迹的影响程度
   - 生成基于影响力排序的热点列表

2. **聚类分析**：

   - 对排放源进行聚类，识别主要排放类别
   - 提供层次化的热点视图

3. **可视化支持**：
   - 生成热力图和桑基图，直观显示排放分布
   - 提供交互式探索功能

## 6. 不确定性分析

### 6.1 不确定性来源

计算引擎识别并量化以下不确定性来源：

1. **参数不确定性**：

   - 活动数据的测量误差
   - 排放因子的变异性

2. **模型不确定性**：

   - 计算方法的简化和假设
   - 系统边界定义的影响

3. **场景不确定性**：
   - 未来情境的预测差异
   - 政策和技术变化的影响

### 6.2 不确定性分析方法

计算引擎实现以下不确定性分析方法：

1. **蒙特卡洛模拟**：

   - 对关键输入参数进行随机采样
   - 执行大量迭代计算，生成概率分布

2. **误差传播**：

   - 使用误差传播公式分析不确定性传递
   - 生成总体不确定性范围

3. **情景分析**：
   - 设置最佳、最差和基准情景
   - 评估不同情景下的结果差异

### 6.3 结果表示

不确定性分析结果以多种形式表示：

1. **置信区间**：95%置信区间表示排放结果
2. **误差棒**：可视化表示中包含误差范围
3. **概率密度函数**：展示结果的完整概率分布
4. **敏感性指数**：量化各因素对总不确定性的贡献

## 7. 计算优化策略

### 7.1 计算性能优化

为提高计算效率，引擎采用以下优化策略：

1. **并行计算**：

   - 利用多线程处理独立的计算任务
   - 使用工作队列管理计算任务

2. **增量计算**：

   - 缓存中间结果，支持局部更新
   - 避免完全重新计算

3. **计算图优化**：

   - 分析计算依赖关系，构建优化的计算图
   - 减少冗余计算

4. **分层缓存**：
   - 缓存频繁使用的数据和中间结果
   - 实现多级缓存策略(内存、本地、分布式)

### 7.2 大规模计算支持

支持大型组织的批量计算需求：

1. **批处理引擎**：

   - 高效处理大量产品的碳足迹计算
   - 优化资源利用和调度

2. **分布式计算**：

   - 支持跨多个节点的分布式计算
   - 基于Kubernetes的计算资源编排

3. **优先级队列**：
   - 根据业务重要性分配计算资源
   - 支持紧急计算任务插队

## 8. 计算引擎API

### 8.1 核心API

计算引擎提供以下核心API：

1. **创建计算任务**：

   ```
   POST /api/v1/calculations

   请求体：
   {
     "productId": "uuid",
     "method": "process-based",
     "boundary": "cradle-to-gate",
     "allocationMethod": "economic",
     "parameters": {
       "functionalUnit": "1 piece",
       "considerRecycling": true
     }
   }
   ```

2. **获取计算状态**：

   ```
   GET /api/v1/calculations/{id}
   ```

3. **获取计算结果**：

   ```
   GET /api/v1/calculations/{id}/results
   ```

4. **模拟计算**：

   ```
   POST /api/v1/calculations/simulate

   请求体：
   {
     "productId": "uuid",
     "changes": [
       {
         "type": "material",
         "id": "uuid",
         "quantity": 1.5
       },
       {
         "type": "emission_factor",
         "id": "uuid",
         "value": 2.4
       }
     ]
   }
   ```

### 8.2 批量计算API

支持批量计算操作：

```
POST /api/v1/calculations/batch

请求体：
{
  "productIds": ["uuid1", "uuid2", "uuid3"],
  "method": "process-based",
  "boundary": "cradle-to-gate",
  "allocationMethod": "economic"
}
```

### 8.3 计算引擎配置API

提供引擎配置管理功能：

```
GET /api/v1/calculations/settings
PUT /api/v1/calculations/settings

请求体：
{
  "defaultMethod": "process-based",
  "defaultBoundary": "cradle-to-gate",
  "defaultAllocationMethod": "economic",
  "uncertaintyAnalysis": {
    "enabled": true,
    "method": "monte-carlo",
    "iterations": 1000
  },
  "aiFeatures": {
    "dataValidation": true,
    "dataCompletion": true,
    "hotspotAnalysis": true
  }
}
```

## 9. MVP阶段计算引擎实现

考虑到MVP阶段(Q3 2025)的开发重点，计算引擎将做以下简化：

### 9.1 MVP核心功能

1. **基础计算方法**：

   - 实现简单累加法和基础过程法
   - 支持摇篮到大门(Cradle-to-Gate)边界
   - 支持基本的物理分配方法

2. **简化数据处理**：

   - 基础数据验证功能
   - 简单的数据预处理和后处理
   - 有限的数据补全能力

3. **基础不确定性分析**：
   - 实现简单的误差传播计算
   - 提供基本的不确定性表示

### 9.2 MVP阶段架构

MVP阶段简化的计算引擎架构：

```
┌───────────────────────────────────────────────────────────────┐
│                      计算引擎API层                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐    │
│  │  计算任务管理   │  │  参数验证       │  │  结果管理   │    │
│  └─────────────────┘  └─────────────────┘  └─────────────┘    │
└─────────────────────────────┬─────────────────────────────────┘
                              │
┌─────────────────────────────▼─────────────────────────────────┐
│                      计算核心层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐    │
│  │  数据预处理     │  │  基础计算方法   │  │  结果汇总   │    │
│  └─────────────────┘  └─────────────────┘  └─────────────┘    │
└─────────────────────────────┬─────────────────────────────────┘
                              │
┌─────────────────────────────▼─────────────────────────────────┐
│                      数据访问层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐    │
│  │  产品/BOM数据   │  │  活动数据       │  │ 排放因子    │    │
│  └─────────────────┘  └─────────────────┘  └─────────────┘    │
└───────────────────────────────────────────────────────────────┘
```

### 9.3 后续迭代计划

MVP之后的迭代升级计划：

1. **2025Q4**：

   - 添加高级计算方法(IOA, 混合法)
   - 增强AI数据验证能力
   - 实现完整的不确定性分析

2. **2026Q1**：

   - 实现高级分配方法
   - 添加热点分析功能
   - 增强批量计算能力

3. **2026Q2-Q4**：
   - 实现分布式计算架构
   - 增强AI预测和优化功能
   - 支持实时计算和监控

## 10. 技术实现细节

### 10.1 技术栈选择

计算引擎的技术实现基于以下技术栈：

1. **核心开发语言**：

   - Node.js (计算服务API)
   - Python (数据处理和AI模型)

2. **计算库**：

   - NumPy/Pandas：数据处理和数值计算
   - SciPy：科学计算和不确定性分析
   - TensorFlow/PyTorch：AI模型实现

3. **服务架构**：
   - Docker容器化部署
   - 阿里云容器服务
   - 消息队列：RabbitMQ

### 10.2 计算算法实现

核心计算算法的伪代码实现：

```python
def calculate_pcf(product_id, method, boundary, allocation_method):
    # 加载产品和BOM数据
    product = load_product(product_id)
    bom_items = load_bom_items(product_id)

    # 初始化总排放量
    total_emissions = 0

    # 处理每个BOM项
    for item in bom_items:
        # 获取物料相关的活动数据
        activity_data = load_activity_data(item.material_id)

        # 选择合适的排放因子
        emission_factor = select_emission_factor(
            item.material_id,
            item.emission_factor_id
        )

        # 数据验证和补全
        validated_data = validate_data(activity_data)
        if has_missing_data(validated_data):
            completed_data = complete_missing_data(validated_data)
        else:
            completed_data = validated_data

        # 计算该物料的排放量
        material_emissions = calculate_material_emissions(
            item.quantity,
            item.unit,
            completed_data,
            emission_factor,
            method,
            boundary
        )

        # 应用分配方法
        if needs_allocation(item):
            allocation_factor = calculate_allocation_factor(
                item,
                allocation_method
            )
            material_emissions *= allocation_factor

        # 累加到总排放量
        total_emissions += material_emissions

    # 添加产品级别的活动排放
    product_activity_emissions = calculate_product_activity_emissions(
        product_id,
        boundary
    )
    total_emissions += product_activity_emissions

    # 不确定性分析
    uncertainty = calculate_uncertainty(
        bom_items,
        total_emissions
    )

    # 生成热点分析
    hotspots = identify_hotspots(bom_items, total_emissions)

    # 返回结果
    return {
        'product_id': product_id,
        'total_emissions': total_emissions,
        'unit': 'kg CO2e',
        'uncertainty': uncertainty,
        'hotspots': hotspots,
        'method': method,
        'boundary': boundary,
        'allocation_method': allocation_method
    }
```

### 10.3 性能指标

计算引擎的性能目标：

1. **响应时间**：

   - 单个产品计算: < 5秒
   - 复杂产品计算: < 30秒
   - 批量计算(10个产品): < 2分钟

2. **吞吐量**：

   - 单节点支持: > 100次计算/小时
   - 集群支持: > 1000次计算/小时

3. **可靠性**：
   - 服务可用性: 99.9%
   - 计算准确性: 与手动计算结果偏差 < 1%

## 11. 结论

计算引擎是AI驱动的产品碳足迹量化平台的核心组件，提供准确、灵活的碳足迹计算能力。设计采用分层架构，支持多种计算方法和标准，并通过AI技术增强数据处理和分析能力。

在MVP阶段，我们将实现基础功能，提供简化但实用的计算能力。随着系统迭代发展，计算引擎将逐步增强功能和性能，最终实现全面、准确、智能的碳足迹量化解决方案。
