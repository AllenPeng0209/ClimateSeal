# 系统架构文档：AI驱动的产品碳足迹量化平台

## 1. 系统概述

本文档描述了AI驱动的产品碳足迹量化平台的系统架构。该平台旨在帮助企业高效、准确地计算产品碳足迹，通过AI技术提升数据处理能力，支持企业低碳转型决策。系统基于现代Web技术栈构建，采用前后端分离架构，并部署在阿里云容器服务上。

### 1.1 业务需求概述

根据PRD文档，系统主要解决以下业务需求：

- 简化和自动化企业计算、管理和报告产品碳足迹的流程
- 提升效率，大幅缩短PCF计算周期，减少人工投入
- 提高准确性，利用AI技术处理数据缺失、提高数据质量，提供更可靠的计算结果
- 赋能决策，提供深入的数据分析和洞察，帮助识别减排热点
- 确保合规，支持ISO 14067, GHG Protocol等主流国际标准

### 1.2 目标用户

- 可持续发展/ESG部门经理与专员
- 产品设计师/研发工程师
- 供应链/采购经理
- 生产/运营经理
- 财务/审计人员
- 企业高管

## 2. 系统架构概览

### 2.1 总体架构

系统采用现代化的微服务架构，包含以下主要组件：

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户访问层                                │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │
│  │   浏览器    │    │  移动设备   │    │  桌面应用   │          │
│  └─────────────┘    └─────────────┘    └─────────────┘          │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                        负载均衡层                                │
│                 ┌─────────────────────────┐                     │
│                 │     阿里云SLB/Nginx     │                     │
│                 └─────────────────────────┘                     │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                       前端应用层 (Remix)                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │
│  │  UI组件     │    │  状态管理   │    │  路由管理   │          │
│  └─────────────┘    └─────────────┘    └─────────────┘          │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                         API网关层                                │
│                 ┌─────────────────────────┐                     │
│                 │      API Gateway        │                     │
│                 └─────────────────────────┘                     │
└─────────────────┬─────────────────────────┬─────────────────────┘
                  │                         │
┌─────────────────▼──────┐      ┌──────────▼─────────────────────┐
│     微服务集群         │      │         数据存储层              │
│  ┌─────────────────┐   │      │  ┌─────────────┐ ┌───────────┐ │
│  │ 用户管理服务    │   │      │  │ PostgreSQL  │ │  Redis    │ │
│  ├─────────────────┤   │      │  └─────────────┘ └───────────┘ │
│  │ 产品管理服务    │   │      │  ┌─────────────┐               │
│  ├─────────────────┤   │      │  │ 对象存储    │               │
│  │ 数据管理服务    │   │      │  └─────────────┘               │
│  ├─────────────────┤   │      └──────────────────────────────┘  │
│  │ 计算引擎服务    │   │                      ▲                 │
│  ├─────────────────┤   │                      │                 │
│  │ 报告生成服务    │   │      ┌──────────────┴───────────────┐  │
│  ├─────────────────┤   │      │           AI服务层            │  │
│  │ 知识库服务      │   │      │  ┌─────────────┐ ┌─────────┐  │  │
│  └─────────────────┘   │      │  │ 数据验证AI  │ │ 推荐AI  │  │  │
└──────────────────────┘        │  └─────────────┘ └─────────┘  │  │
                                │  ┌─────────────┐ ┌─────────┐  │  │
                                │  │ 数据补全AI  │ │ 咨询AI  │  │  │
                                │  └─────────────┘ └─────────┘  │  │
                                └──────────────────────────────┘
```

### 2.2 技术栈概览

#### 前端技术栈

- **框架**: Remix (React)
- **UI库**: 自定义组件 + Ant Design
- **状态管理**: Jotai/Zustand
- **数据可视化**: Ant Design Charts/Plots
- **API通信**: Fetch API, React Query

#### 后端技术栈

- **API服务**: Node.js
- **数据库**: PostgreSQL (Supabase)
- **缓存**: Redis
- **搜索引擎**: Elasticsearch
- **消息队列**: RabbitMQ
- **对象存储**: 阿里云OSS

#### AI技术组件

- **数据验证AI**: 基于机器学习的异常值检测
- **数据补全AI**: 时间序列预测和相似性匹配
- **推荐AI**: 基于上下文的排放因子推荐
- **碳咨询AI**: 基于大语言模型的问答系统

#### DevOps工具链

- **容器化**: Docker
- **编排**: Docker Compose
- **CI/CD**: 阿里云容器服务 + GitHub Actions
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack

## 3. 前端架构

### 3.1 Remix应用架构

Remix是一个全栈Web框架，基于React构建，支持服务端渲染(SSR)和客户端水合(hydration)，提供出色的用户体验和性能优化。

#### 目录结构

```
app/
├── components/      # 可复用UI组件
├── contexts/        # React上下文
├── hooks/           # 自定义Hooks
├── lib/             # 工具函数和库
├── routes/          # 应用路由和页面组件
├── services/        # API服务和数据获取
├── styles/          # 全局样式和主题
├── templates/       # 页面模板
├── types/           # TypeScript类型定义
├── utils/           # 通用工具函数
├── entry.client.tsx # 客户端入口
├── entry.server.tsx # 服务端入口
└── root.tsx         # 应用根组件
```

### 3.2 核心功能模块

#### 用户界面模块

- **仪表板**: 展示关键指标和任务
- **产品管理**: 产品库、BOM管理、物料主数据管理
- **数据收集**: 数据导入、验证和管理
- **计算引擎**: 碳足迹计算和结果管理
- **报告分析**: 标准报告、自定义报告、可视化分析
- **知识库**: 行业知识、法规解读、最佳实践

#### 状态管理

- 使用Jotai/Zustand进行全局状态管理
- 使用React Context处理组件树级别的状态共享
- 使用React Query管理服务器状态和数据缓存

#### 响应式设计

- 适配不同屏幕尺寸(从1024px到1920px)
- 移动优先设计原则
- 针对高分辨率显示器优化

## 4. 后端架构

### 4.1 微服务架构

系统后端采用微服务架构，将不同功能模块拆分为独立的服务，提高系统的可扩展性和维护性。

#### 核心微服务

- **用户管理服务**: 负责用户认证、授权和权限管理
- **产品管理服务**: 处理产品、BOM和物料数据
- **数据管理服务**: 管理活动数据、排放因子和供应商数据
- **计算引擎服务**: 执行碳足迹计算和结果处理
- **报告生成服务**: 生成标准和自定义报告
- **知识库服务**: 管理和检索知识内容
- **AI服务**: 提供智能数据处理和分析能力

### 4.2 数据库设计

#### 核心实体及关系

系统的主要数据实体包括:

- Product (产品)
- Material (物料)
- BOM (物料清单)
- EmissionFactor (排放因子)
- ActivityData (活动数据)
- PCFCalculation (碳足迹计算)
- PCFResult (计算结果)
- Report (报告)
- User (用户)
- Organization (组织)
- KnowledgeItem (知识项)

### 4.3 API设计

采用RESTful API设计规范，主要API模块包括:

- 产品管理API
- 数据管理API
- 计算引擎API
- 报告API
- 用户管理API
- 工作流API
- 知识库API
- AI顾问API

### 4.4 安全架构

- **认证**: OAuth 2.0 / JWT
- **授权**: 基于角色(RBAC)和属性(ABAC)的访问控制
- **数据加密**: 传输层(TLS)和存储层加密
- **API安全**: 速率限制、CORS、CSP
- **审计日志**: 记录所有关键操作和访问历史

## 5. AI组件架构

### 5.1 数据智能

- **数据验证AI**: 使用异常检测算法识别异常值和不一致数据
- **数据补全AI**: 基于历史数据和相似产品数据进行智能数据填补
- **排放因子推荐**: 根据产品属性推荐最适合的排放因子

### 5.2 减排智能

- **热点识别**: 识别产品碳足迹的主要贡献点
- **物料替代分析**: 推荐低碳替代材料
- **供应商优化**: 分析供应商碳绩效，推荐更环保的选择

### 5.3 AI顾问系统

- 基于大语言模型的智能问答系统
- 多轮对话能力，理解用户意图
- 上下文感知，能够回答专业领域问题
- 集成知识库内容，提供准确回答

## 6. 阿里云Docker部署架构

### 6.1 容器化策略

- 每个微服务独立容器化，便于扩展和维护
- 使用多阶段构建优化Docker镜像大小
- 前端应用容器化，与后端API分离部署

### 6.2 阿里云资源配置

#### 基础设施

- **ECS实例**: 阿里云弹性计算服务，用于运行Docker容器
- **容器服务**: 阿里云容器服务ACK管理Kubernetes集群
- **SLB**: 阿里云负载均衡服务，提供高可用访问
- **VPC**: 私有网络环境，保障系统安全
- **OSS**: 对象存储服务，存储报告和文档

#### Docker部署架构

```
┌───────────────────────────────────┐
│            阿里云SLB              │
└────────────────┬──────────────────┘
                 │
┌────────────────▼──────────────────┐
│               Nginx               │
└────┬─────────────────┬────────────┘
     │                 │
┌────▼────┐      ┌─────▼─────┐
│ 前端容器 │      │ API网关容器│
└────┬────┘      └─────┬─────┘
     │                 │
     │    ┌────────────┼─────────────────┐
     │    │            │                 │
┌────▼────▼─┐   ┌──────▼───────┐   ┌─────▼──────┐
│ 用户服务容器│   │ 产品服务容器  │   │ 数据服务容器│
└────────────┘   └──────────────┘   └────────────┘
     │                 │                 │
     └─────────────────┼─────────────────┘
                       │
                 ┌─────▼──────┐
                 │  数据库容器 │
                 └────────────┘
```

### 6.3 扩展性与可用性

- **水平扩展**: 根据负载自动扩展容器实例
- **多可用区部署**: 跨可用区部署提高系统可用性
- **自动恢复**: 容器健康检查和自动重启
- **蓝绿部署**: 无缝更新，最小化停机时间

### 6.4 部署流程

1. **本地开发**:

   - 使用Docker Compose进行本地开发和测试
   - 使用标准化的开发环境确保一致性

2. **CI/CD流程**:

   - GitHub Actions触发自动构建
   - 构建Docker镜像并推送到阿里云容器镜像服务
   - 自动部署到不同环境(开发、测试、生产)

3. **环境配置**:

   - 使用环境变量进行不同环境配置
   - 敏感信息使用阿里云KMS加密保存

4. **监控与日志**:
   - 使用Prometheus监控容器和应用健康状态
   - ELK Stack集中收集和分析日志
   - 设置警报机制及时响应异常

## 7. 性能与扩展性考量

### 7.1 性能优化

- **前端性能**:

  - 代码分割减小初始加载体积
  - 资源预加载和缓存策略
  - 图像优化和延迟加载

- **API性能**:

  - API结果缓存减少计算开销
  - 批处理API减少请求次数
  - 压缩响应减少网络传输开销

- **数据库性能**:
  - 索引优化提高查询效率
  - 查询优化减少不必要的数据加载
  - 读写分离应对高并发场景

### 7.2 扩展性设计

- **微服务解耦**: 服务间通过API通信，支持独立扩展
- **无状态设计**: 便于水平扩展和负载均衡
- **数据分区**: 针对大数据量采用分区策略
- **消息队列**: 处理异步任务和服务间通信
- **多租户架构**: 隔离不同企业客户数据

### 7.3 MVP阶段简化架构

针对MVP阶段（Q3 2025），系统架构将大幅简化，专注于核心功能快速交付和验证。

#### MVP阶段架构特点

- **简化容器策略**：从之前的多容器微服务架构简化为"3+1"容器结构
- **单体优先**：后端API采用单体架构而非完全微服务
- **降低复杂度**：减少依赖组件，简化部署和运维
- **保留扩展空间**：设计预留未来拆分为微服务的可能性

#### MVP容器架构

```
┌───────────────────────────────────┐
│            阿里云SLB              │
└────────────────┬──────────────────┘
                 │
┌────────────────▼──────────────────┐
│               Nginx               │
└────────────────┬──────────────────┘
                 │
     ┌───────────┴───────────┐
     │                       │
┌────▼────┐             ┌────▼────┐
│ Web应用容器 │            │ 计算引擎容器 │
│(前端+API层) │            │          │
└────┬────┘             └────┬────┘
     │                       │
     └───────────┬───────────┘
                 │
        ┌────────▼────────┐
        │                 │
        │   数据库容器     │
        │  (PostgreSQL)   │
        └────────┬────────┘
                 │
        ┌────────▼────────┐
        │                 │
        │   Redis容器     │
        │  (可选)         │
        └─────────────────┘
```

#### MVP阶段技术栈精简

- **前端**：保留Remix框架，减少不必要的UI库和工具
- **后端**：单体API服务，基于Node.js，避免过早微服务拆分
- **数据库**：单一PostgreSQL实例，通过Supabase管理
- **AI集成**：仅实现基础AI对话功能，使用OpenAI或本地部署模型
- **部署**：简化的Docker Compose配置，无需Kubernetes复杂性

#### MVP阶段功能边界

- **核心功能**：

  - 用户认证与基本权限
  - 产品和BOM基础管理
  - 排放因子库和数据导入
  - 基础计算引擎
  - 简单报表生成
  - AI对话助手

- **暂不实现**：
  - 完整微服务架构
  - 高级数据分析和可视化
  - 复杂的权限和工作流管理
  - 知识库完整功能
  - 高级AI数据处理

#### MVP阶段开发流程

- **迭代周期**：2-3周一个迭代，快速交付可用功能
- **持续集成**：简化的CI/CD流程，专注于快速部署
- **测试策略**：关键功能自动化测试，其他功能手动测试
- **反馈循环**：与核心用户紧密合作，频繁收集反馈

## 8. 实施路线图

### 8.1 阶段一: MVP版本(Q3 2025)

MVP阶段将专注于基本功能的快速实现，以验证核心业务价值：

- **基础用户功能**：简单的用户注册、登录和权限控制
- **产品数据管理**：基础产品目录和简化的BOM管理
- **数据收集**：通过Excel模板导入和手动录入数据
- **简化计算引擎**：基本的碳足迹计算功能，支持主要排放源
- **基础排放因子库**：预置常用排放因子数据
- **简单报表**：基础报表导出功能，包含关键数据和图表
- **AI对话助手**：基于大语言模型的简单对话功能，辅助报告生成

采用"3+1"容器架构（Web应用、计算引擎、数据库、Redis缓存），简化部署和运维复杂度。

### 8.2 阶段二: 标准版(Q4 2025)

- 完整用户管理与权限系统
- 更全面的计算引擎
- 标准化报告输出
- 数据质量验证
- 初步API整合能力

### 8.3 阶段三: 企业版(Q1 2026)

- 碳减排目标设定与跟踪
- 高级数据可视化
- 部分供应链数据整合
- 有限的第三方系统集成

### 8.4 长期规划(2028年及以后)

- 完整API平台
- 移动端应用
- 高级AI分析功能
- 更广泛的系统集成

## 9. 结论

本架构文档提供了AI驱动的产品碳足迹量化平台的系统设计。通过采用现代化的技术栈和架构模式，系统能够满足PRD中定义的各项功能需求，同时保证了系统的可扩展性、安全性和性能。基于阿里云Docker的部署方案，为系统提供了高可用、易维护的运行环境。

对于MVP阶段，我们采用了更为简化和实用的架构设计，专注于核心价值交付，同时保留了未来扩展的可能性。随着系统的迭代发展，架构将持续优化，以适应新的业务需求和技术发展。
